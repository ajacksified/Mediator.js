(function(a,b){"use strict";"function"==typeof define&&define.amd?define([],function(){return a.Mediator=b(),a.Mediator}):"undefined"==typeof exports?a.Mediator=b():exports.Mediator=b()})(this,function(){"use strict";function guidGenerator(){var a=function(){return(0|65536*(1+Math.random())).toString(16).substring(1)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function Subscriber(a,b,c){return this instanceof Subscriber?void(this.id=guidGenerator(),this.fn=a,this.options=b,this.context=c,this.channel=null):new Subscriber(a,b,c)}function Channel(a,b){return this instanceof Channel?void(this.namespace=a||"",this._subscribers=[],this._channels={},this._parent=b,this.stopped=!1):new Channel(a)}function Mediator(){return this instanceof Mediator?void(this._channels=new Channel("")):new Mediator}return Subscriber.prototype.update=function(a){a&&(this.fn=a.fn||this.fn,this.context=a.context||this.context,this.options=a.options||this.options,this.channel&&this.options&&void 0!==this.options.priority&&this.channel.setPriority(this.id,this.options.priority))},Channel.prototype.channelPrioritySort=function(c,a){return c.options.priority>a.options.priority?-1:c.options.priority<a.options.priority?1:0},Channel.prototype.addSubscriber=function(a,b,c){b||(b={priority:0}),b.priority|=0;var d=new Subscriber(a,b,c);return d.channel=this,this._subscribers.push(d),this._subscribers.sort(this.channelPrioritySort),d},Channel.prototype.stopPropagation=function(){this.stopped=!0},Channel.prototype.getSubscriber=function(a){var b=0,c=this._subscribers.length;for(b,c;b<c;b++)if(this._subscribers[b].id===a||this._subscribers[b].fn===a)return this._subscribers[b]},Channel.prototype.setPriority=function(a,b){for(var c=0,d=this._subscribers.length;c<d;c++)if(this._subscribers[c].id===a||this._subscribers[c].fn===a){this._subscribers[c].priority=b;break}this._subscribers.sort(this.channelPrioritySort)},Channel.prototype.addChannel=function(a){this._channels[a]=new Channel((this.namespace?this.namespace+":":"")+a,this)},Channel.prototype.hasChannel=function(a){return this._channels.hasOwnProperty(a)},Channel.prototype.returnChannel=function(a){return this._channels[a]},Channel.prototype.removeSubscriber=function(a,b){var c=this._subscribers.length-1;if(b="undefined"==typeof b||b,!a)this._subscribers=[];else for(c;0<=c;c--)(this._subscribers[c].fn===a||this._subscribers[c].id===a)&&(this._subscribers[c].channel=null,this._subscribers.splice(c,1));if(b&&this.autoCleanChannel(),c=this._subscribers.length-1,!a)return void(this._subscribers=[]);for(c;0<=c;c--)(this._subscribers[c].fn===a||this._subscribers[c].id===a)&&(this._subscribers[c].channel=null,this._subscribers.splice(c,1))},Channel.prototype.autoCleanChannel=function(){if(0===this._subscribers.length){for(var a in this._channels)if(this._channels.hasOwnProperty(a))return;if(null!=this._parent){var b=this.namespace.split(":"),c=b[b.length-1];this._parent.removeChannel(c)}}},Channel.prototype.removeChannel=function(a){this.hasChannel(a)&&(this._channels[a]=null,delete this._channels[a],this.autoCleanChannel())},Channel.prototype.publish=function(a){var b,c,d,e=0,f=this._subscribers.length,g=!1;for(e,f;e<f;e++)g=!1,b=this._subscribers[e],this.stopped||(c=this._subscribers.length,void 0!==b.options&&"function"==typeof b.options.predicate?b.options.predicate.apply(b.context,a)&&(g=!0):g=!0),g&&(b.options&&void 0!==b.options.calls&&(b.options.calls--,1>b.options.calls&&this.removeSubscriber(b.id)),b.fn.apply(b.context,a),d=this._subscribers.length,f=d,d===c-1&&e--);this._parent&&this._parent.publish(a),this.stopped=!1},Mediator.prototype.getChannel=function(a,b){var c=this._channels,d=a.split(":"),e=0,f=d.length;if(""===a)return c;if(0<d.length)for(e,f;e<f;e++){if(!c.hasChannel(d[e]))if(b)break;else c.addChannel(d[e]);c=c.returnChannel(d[e])}return c},Mediator.prototype.subscribe=function(a,b,c,d){var e=this.getChannel(a||"",!1);return c=c||{},d=d||{},e.addSubscriber(b,c,d)},Mediator.prototype.once=function(a,b,c,d){return c=c||{},c.calls=1,this.subscribe(a,b,c,d)},Mediator.prototype.getSubscriber=function(a,b){var c=this.getChannel(b||"",!0);return c.namespace===b?c.getSubscriber(a):null},Mediator.prototype.remove=function(a,b,c){var d=this.getChannel(a||"",!0);return d.namespace===a&&void d.removeSubscriber(b,c)},Mediator.prototype.publish=function(a){var b=this.getChannel(a||"",!1);if(b.namespace!==a)return null;var c=Array.prototype.slice.call(arguments,1);c.push(b),b.publish(c)},Mediator.prototype.on=Mediator.prototype.subscribe,Mediator.prototype.bind=Mediator.prototype.subscribe,Mediator.prototype.emit=Mediator.prototype.publish,Mediator.prototype.trigger=Mediator.prototype.publish,Mediator.prototype.off=Mediator.prototype.remove,Mediator.Channel=Channel,Mediator.Subscriber=Subscriber,Mediator.version="0.11.1",Mediator});